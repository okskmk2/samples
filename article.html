<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>파인애플 | 게시글</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <main>
        <h1>게시글</h1>
        <div class="row jc-between action-bar">
            <div>
                <button onclick="location.href='index.html'">목록으로</button>
            </div>
            <div>
                <button id="removeBtn">삭제</button>
                <button id="saveBtn">저장</button>
            </div>
        </div>
        <div class="input-group">
            <label>제목</label>
            <input type="text" id="title" class="full">
        </div>
        <div class="input-group">
            <label>내용</label>
            <textarea id="content" class="full" rows="5"></textarea>
        </div>
        <div class="input-group">
            <label>작성자</label>
            <input type="text" id="reg_name">
        </div>
        <div class="input-group">
            <label>작성일</label>
            <input type="date" id="reg_dt">
        </div>
    </main>
    <script type="module">
        import { Storage, getCurrentUser } from "./js/firebase.js";

        const articleStorage = new Storage('articles');
        const removeBtn = document.getElementById('removeBtn');
        const saveBtn = document.getElementById('saveBtn');
        const title = document.getElementById('title');
        const content = document.getElementById('content');
        const reg_name = document.getElementById('reg_name');
        const reg_dt = document.getElementById('reg_dt');

        const isEditMode = !!location.hash;

        let uuid;

        if (isEditMode) {
            uuid = location.hash.substring(1);
        }

        // 편집 모드
        if (isEditMode) {
            articleStorage.get(uuid).then(item => {
                title.value = item.title;
                content.value = item.content;
                reg_name.value = item.reg_name;
                reg_dt.value = item.reg_dt;
                let viewCnt = item.viewCnt ?? 0;
                viewCnt++;
                articleStorage.update(uuid, { viewCnt });
            });
        }
        // 추가 모드
        else {
            getCurrentUser().then((user) => {
                reg_name.value = user.displayName ?? user.email;
                reg_dt.valueAsDate = new Date();
            }).catch(() => {
                alert('회원만 접근할 수 있는 페이지입니다.');
                location.href = 'login.html?redirect=' + encodeURIComponent('article.html');
            })

        }

        async function save() {
            const item = {
                title: title.value || '무제',
                content: content.value,
                reg_name: reg_name.value,
                reg_dt: reg_dt.value
            };
            if (isEditMode) {
                articleStorage.update(uuid, item);
                alert('수정하였습니다.');
            } else {
                item.viewCnt = 0;
                articleStorage.add(item);
                alert('추가하였습니다.');
            }
        }

        async function remove() {
            if (confirm('정말로 삭제하시겠습니까?')) {
                await articleStorage.remove(uuid);
                location.href = 'index.html';
            }
        }

        saveBtn.addEventListener('click', save);
        removeBtn.addEventListener('click', remove);
    </script>
</body>
</html>